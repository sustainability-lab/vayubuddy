<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.39">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Zeel B. Patel, Yash Bachwana, Nitish Sharma, Sarath Guttikunda, Nipun Batra">

<title>VayuBuddy: An LLM-Powered Chatbot to Democratize Air Quality Insights</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-e26003cea8cd680ca0c55a263523d882.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-d4be639c637f3db3c684c66cefad7e0c.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="fullcontent">

<div id="quarto-search-results"></div>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">VayuBuddy: An LLM-Powered Chatbot to Democratize Air Quality Insights</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Zeel B. Patel, Yash Bachwana, Nitish Sharma, Sarath Guttikunda, Nipun Batra </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<p>Interact with chatbot directly: <a href="https://huggingface.co/spaces/SustainabilityLabIITGN/VayuBuddy">VayuBuddy</a></p>
<section id="abstract" class="level1">
<h1>Abstract</h1>
<p>Nearly 6.7 million lives are lost due to air pollution every year. While policymakers are working on the mitigation strategies, public awareness can help reduce the exposure to air pollution. Air pollution data from government-installed sensors is often publicly available in raw format, but there is a non-trivial barrier for various stakeholders in deriving meaningful insights from that data. In this work, we present VayuBuddy, a Large Language Model (LLM)-powered chatbot system to reduce the barrier between the stakeholders and air quality sensor data. VayuBuddy receives the questions in natural language, analyses the structured sensory data with a LLM-generated Python code and provides answers in natural language. We use the data from Indian government air quality sensors. We benchmark the capabilities of 7 LLMs on 45 diverse question-answer pairs prepared by us. Additionally, VayuBuddy can also generate visual analysis such as line-plots, map plot, bar charts and many others from the sensory data as we demonstrate in this work.</p>
<p><strong>As a testament to its innovative design and real-world relevance, VayuBuddy has been featured in multiple newspaper articles. These articles provide insights into its applications, societal impact, and reception by users.</strong></p>
<p align="center">
<img src="imgs/newspaper.png" alt="Newspaper Cuttings" style="width: 130%; border: 1px solid #ddd;"> 
</p>
<p align="center">
<strong>Media Coverage of VayuBuddy Chatbot</strong>
</p>
</section>
<section id="dataset" class="level1">
<h1>Dataset</h1>
<section id="source" class="level3">
<h3 class="anchored" data-anchor-id="source">Source:</h3>
<p>Central Pollution Control Board (CPCB), India. ### Details: Covers 537 monitoring stations across 279 cities in 31 states. 7 years of PM2.5 data (2017‚Äì2023) resampled to daily averages.</p>
<p>Using the above theorem, probability statements about the sample mean can be approximated using a normal distribution. It‚Äôs the probability statements that are being approximated, not the random variable itself.</p>
</section>
</section>
<section id="flowchart-of-vayubuddy-system" class="level1">
<h1>Flowchart of VayuBuddy System</h1>
<p align="center">
<img src="imgs/Picture2.png" alt="flowchart">
</p>
<p align="center">
Figure 2: Flowchart of the VayuBuddy Chatbot
</p>
</section>
<section id="prompts-given-to-the-llm-system-prompts-additional-information-and-direction-given-to-the-llm." class="level1">
<h1>Prompts Given to the LLM: System Prompts, Additional information and direction given to the LLM.</h1>
<ul>
<li>The columns are ‚ÄòTimestamp‚Äô, ‚Äòstation‚Äô, ‚ÄòPM2 .5‚Äô, ‚ÄòPM10‚Äô, ‚Äòaddress‚Äô, ‚Äòcity‚Äô, ‚Äòlatitude‚Äô, ‚Äô longitude‚Äô,and ‚Äòstate‚Äô.</li>
<li>Frequency of data is daily.</li>
<li><code>pollution</code> generally means <code>PM2.5</code>.</li>
<li>Don‚Äôt print anything, but save result in a variable <code>answer</code> and make it global.</li>
<li>Unless explicitly mentioned, don‚Äôt consider the result as a plot.</li>
<li>PM2.5 guidelines: India: 60, WHO: 15.</li>
<li>PM10 guidelines: India: 100, WHO: 50.</li>
<li>If result is a plot, show the India and WHO guidelines in the plot.</li>
<li>If result is a plot make it in tight layout, save it and save path in <code>answer</code>. Example: <code>answer='plot.png'</code></li>
<li>If result is a plot, rotate x-axis tick labels by 45 degrees.</li>
<li>If result is not a plot, save it as a string in <code>answer</code>. Example: <code>answer='The city is Mumbai'</code></li>
<li>I have a geopandas.geodataframe india containining the coordinates required to plot Indian Map with states.</li>
<li>If the query asks you to plot on India Map, use that geodataframe to plot and then add more points as per the requirements using the similar code as follows : v = ax.scatter(df[‚Äòlongitude‚Äô], df[‚Äòlatitude‚Äô]). If the colorbar is required , use the following code : plt.colorbar(v)</li>
<li>If the query asks you to plot on India Map plot the India Map in Beige color</li>
<li>Whenever you do any sort of aggregation, report the corresponding standard deviation, standard error and the number of data points for that aggregation.</li>
<li>Whenever you‚Äôre reporting a floating point number, round it to 2 decimal places.</li>
<li>Always report the unit of the data. Example: The average PM2.5 is 45.67 ùúáùëîùëö‚àí3.</li>
</ul>
</section>
<section id="impact-of-the-vayubuddy-chatbot" class="level1">
<h1>Impact of the VayuBuddy Chatbot</h1>
<p><strong>Health Impact:</strong> - PM2.5 pollutants are major contributors to life-threatening diseases, such as respiratory and cardiovascular conditions.</p>
<ul>
<li>Gaining insights into PM2.5 pollution levels is crucial for implementing effective mitigation strategies.</li>
</ul>
<p><strong>Accessibility:</strong> - Democratizes air quality data analysis.&nbsp;This makes the data accessible to non-experts which reduces dependency on technical knowledge or resources.</p>
<ul>
<li><p>Empowers stakeholders like policymakers, researchers, and the public to make informed decisions.</p></li>
<li><p>The public can make healthier lifestyle choices, such as wearing masks or avoiding outdoor activities during high pollution periods.</p></li>
</ul>
</section>
<section id="evaluation-of-the-llms" class="level1">
<h1>Evaluation of the LLMs</h1>
<p><strong>Automated Evaluation Pipeline :</strong> - Built to make Evaluation faster and fair. - Ensures all possible correct answers are included.</p>
<p><strong>How we measure Correctness:</strong> - 1 point : Correct Answer - 0 point : Incorrect Answer</p>
<p><strong>When is it incorrect? :</strong> - LLM doesn‚Äôt generate the code - LLM generates code but gives an error while running. - LLM generates code runs but gives wrong answers.</p>
<p>You can see in the results that all the models are given points according to the 45 pre-prompted questions.</p>
</section>
<section id="results" class="level1">
<h1>Results</h1>
<p><strong>Table 1:</strong> <em>Overall Performance of LLMs on all evaluation queries.</em></p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Model</th>
<th># Params</th>
<th>Score (out of 45)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Llama3.1</td>
<td>70B</td>
<td>39</td>
</tr>
<tr class="even">
<td>Llama3</td>
<td>70B</td>
<td>38</td>
</tr>
<tr class="odd">
<td>Codestral</td>
<td>22B</td>
<td>29</td>
</tr>
<tr class="even">
<td>Mixtral</td>
<td>56B</td>
<td>26</td>
</tr>
<tr class="odd">
<td>Llama3.1</td>
<td>8B</td>
<td>23</td>
</tr>
<tr class="even">
<td>Llama3</td>
<td>8B</td>
<td>21</td>
</tr>
<tr class="odd">
<td>Gemma</td>
<td>9B</td>
<td>19</td>
</tr>
<tr class="even">
<td>Codestral Mamba</td>
<td>7B</td>
<td>19</td>
</tr>
<tr class="odd">
<td>Mistral</td>
<td>7B</td>
<td>8</td>
</tr>
<tr class="even">
<td>Gemma</td>
<td>7B</td>
<td>7</td>
</tr>
</tbody>
</table>
<ul>
<li><p>LLama3 models are performing the best among all models, with Codestral and Mixtral following LLama in performance.</p></li>
<li><p>Models with more parameters tend to perform better compared to those with fewer parameters.</p></li>
</ul>
<p><strong>Table 2:</strong> <em>Performance of LLMs on different stakeholders.</em></p>
<table class="caption-top table">
<colgroup>
<col style="width: 25%">
<col style="width: 17%">
<col style="width: 18%">
<col style="width: 18%">
<col style="width: 10%">
<col style="width: 9%">
</colgroup>
<thead>
<tr class="header">
<th>Model</th>
<th>Policymakers</th>
<th>AQ Researcher</th>
<th>Lung Patients</th>
<th>Parents</th>
<th>Public</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Llama3-70b</td>
<td>19</td>
<td>15</td>
<td>16</td>
<td>20</td>
<td>24</td>
</tr>
<tr class="even">
<td>Mixtral</td>
<td>15</td>
<td>11</td>
<td>11</td>
<td>15</td>
<td>14</td>
</tr>
<tr class="odd">
<td>Gemma-7b</td>
<td>2</td>
<td>2</td>
<td>6</td>
<td>6</td>
<td>4</td>
</tr>
<tr class="even">
<td>Llama3.1-70b</td>
<td>20</td>
<td>16</td>
<td>16</td>
<td>20</td>
<td>24</td>
</tr>
<tr class="odd">
<td>Codestral Mamba</td>
<td>8</td>
<td>7</td>
<td>8</td>
<td>9</td>
<td>13</td>
</tr>
<tr class="even">
<td>Codestral</td>
<td>14</td>
<td>12</td>
<td>15</td>
<td>18</td>
<td>19</td>
</tr>
<tr class="odd">
<td>Mistral 7B</td>
<td>5</td>
<td>3</td>
<td>3</td>
<td>3</td>
<td>5</td>
</tr>
<tr class="even">
<td>Llama3-8b</td>
<td>11</td>
<td>7</td>
<td>11</td>
<td>14</td>
<td>15</td>
</tr>
<tr class="odd">
<td>Llama3.1-8b</td>
<td>10</td>
<td>8</td>
<td>12</td>
<td>13</td>
<td>17</td>
</tr>
<tr class="even">
<td>Gemma-9b</td>
<td>8</td>
<td>7</td>
<td>12</td>
<td>13</td>
<td>12</td>
</tr>
</tbody>
</table>
<ul>
<li><p>We observe that in almost all cases LLMs were able to generate either errorless or faulty Python codes. We rarely see a case where any code is not generated.</p></li>
<li><p>Llama3 provides a good balance between code generation and general knowledge. Code based LLMs failed at questions which required prior information about lockdown and festival seasons, while models Gemma and Mistral lack pretraining on codes</p></li>
</ul>
</section>
<section id="findings" class="level1">
<h1>FINDINGS</h1>
<p align="center">
<img src="imgs/Plot_q.png" alt="Answer for Plot Question">
</p>
<p align="center">
Figure 3: Graph of the monthly average PM 2.5 for the year 2023
</p>
<p align="center" style="font-size: 1.5em; font-weight: bold;">
Gave some custom questions generated by ChatGPT to ask to the model.
</p>
<ul>
<li><p>‚ÄúWhich state in India currently has the highest PM2.5 levels?‚Äù</p></li>
<li><p>‚ÄúWhich state in India has the lowest PM2.5 levels according to the data?‚Äù</p></li>
<li><p>‚ÄúWhat is the PM2.5 level in India‚Äôs most polluted city?‚Äù</p></li>
<li><p>‚ÄúWhich region in India shows the highest PM2.5 concentration throughout the year?‚Äù</p></li>
<li><p>‚ÄúDuring which month does India experience the highest PM2.5 levels on average?‚Äù</p></li>
<li><p>‚ÄúWhich state in India has the most significant decrease in PM2.5 levels?‚Äù</p></li>
<li><p>‚ÄúHow do the PM2.5 levels in northern India compare to southern India?‚Äù</p></li>
<li><p>‚ÄúWhich city in India consistently shows the highest PM2.5 levels?‚Äù</p></li>
<li><p>‚ÄúWhat is the PM2.5 level in India‚Äôs least polluted state?‚Äù</p></li>
<li><p>‚ÄúIn which month do PM2.5 levels peak in Indian cities?‚Äù</p></li>
</ul>
<p><strong>For Question ‚ÄúWhich state in India currently has the highest PM2.5 levels?‚Äù</strong></p>
<ul>
<li><p>Out of 4 models in the given bot Llama3 and Gemini pro gave the answers.</p></li>
<li><p>The finding i found was it gave different answers for the same question. Llama3 gave the answer as ‚ÄúDelhi‚Äù and Gemini pro gave the answer as ‚ÄúMaharashtra‚Äù.</p></li>
</ul>
<p align="center">
<img src="imgs/Q1_gemini.png" alt="Gemini pro answer">
</p>
<p align="center">
Figure 4: Gemini pro answer
</p>
<p align="center">
<img src="imgs/Q1_llama3.png" alt="llama3 answer">
</p>
<p align="center">
Figure 5: Llama3 answer
</p>
<p><strong>Great thing about the VayuBuddy is that it can give the map plot also for the given question.</strong></p>
<p align="center">
<img src="imgs/map_plot.png" alt="map_plot">
</p>
<p align="center">
Figure 6: Showing Map plots for the following question
</p>
<ul>
<li><p>Some of the observations we found was that the model was able to generate the code for the given question and also gave the answer for the same.</p></li>
<li><p>For the above questions which we generated from ChatGPT only two models were able to answer those question which were Llama3 and Gemini pro.</p></li>
<li><p>The answers given by the models were different for the same question which shows that the model is not able to give the correct answer for the same question.</p></li>
<li><p>Llama3 model was able to answer all questions correctly which were generated by ChatGPT.</p></li>
<li><p>We observed that only Llama3 model was able to generate the graphs and map plots for the asking question related to that.</p></li>
</ul>
</section>
<section id="limitations-and-future-work" class="level1">
<h1>Limitations and Future Work</h1>
<ul>
<li><p>It is limited to Indian air quality data. We can extend beyond and include data from other countries.</p></li>
<li><p>It lacks fine-tuning on domain-specific tasks.</p></li>
<li><p>It faces difficulty handling multi-station queries.We can use advanced methods to effectively process and respond.</p></li>
<li><p>This system only specifically focuses on one pollutant, PM<sub>2.5</sub>. We can include more pollutants like SO<sub>2</sub>, NO<sub>2</sub>, CO, and O<sub>3</sub> for comprehensive air monitoring.</p></li>
<li><p>It relies on zero-shot prompting only and hasn‚Äôt been evaluated with other prompting methods like chain of thought, tree of thought, and react prompting.</p></li>
<li><p>The Library installation process is not automated and requires manual setup.</p></li>
</ul>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "Óßã";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>